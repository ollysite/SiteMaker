<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScraperPark AI Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Prism.js for Syntax Highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #site-frame { width: 100%; height: 100%; border: none; background: white; }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(107, 114, 128, 0.8); }

        /* ì±„íŒ… ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: fadeIn 0.3s ease-out forwards; }
        
        /* ìš”ì†Œ ì„ íƒ ëª¨ë“œ í•˜ì´ë¼ì´íŠ¸ */
        .element-highlight {
            outline: 3px solid #3b82f6 !important;
            outline-offset: 2px !important;
            cursor: crosshair !important;
        }
        .element-selected {
            outline: 3px solid #10b981 !important;
            outline-offset: 2px !important;
        }
        
        /* íŒŒì¼ íƒìƒ‰ê¸° */
        .file-item:hover { background: rgba(59, 130, 246, 0.1); }
        .file-item.active { background: rgba(59, 130, 246, 0.2); border-left: 2px solid #3b82f6; }
        
        /* í€µ ì•¡ì…˜ ë²„íŠ¼ */
        .quick-btn { transition: all 0.2s; }
        .quick-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* ì½”ë“œ ë·°ì–´ */
        .code-panel { 
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; 
            font-size: 13px;
            line-height: 1.6;
        }
        .code-panel pre[class*="language-"] {
            margin: 0;
            padding: 1rem;
            background: #1e1e2e !important;
            border-radius: 0;
        }
        .code-panel .line-numbers .line-numbers-rows {
            border-right: 1px solid #3b4261;
            padding-right: 0.5rem;
        }
        .code-panel .line-numbers-rows > span:before {
            color: #4b5563;
        }
        
        /* íŒŒì¼ íƒ­ ë°” */
        .file-tab {
            background: #1f2937;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .file-tab:hover {
            background: #374151;
        }
        .file-tab.active {
            background: #1e1e2e;
            border-bottom-color: #3b82f6;
        }
        
        /* Preview/Code í† ê¸€ */
        .view-toggle {
            background: #374151;
            border-radius: 8px;
            padding: 2px;
        }
        .view-toggle button {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .view-toggle button.active {
            background: #3b82f6;
            color: white;
        }
        
        /* íŒŒì¼ íŠ¸ë¦¬ ê°œì„  */
        .folder-toggle {
            transition: transform 0.2s;
        }
        .folder-toggle.open {
            transform: rotate(90deg);
        }
        .file-tree-item {
            transition: background 0.15s;
        }
        .file-tree-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        .file-tree-item.active {
            background: rgba(59, 130, 246, 0.2);
            border-left: 2px solid #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">
    
    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="h-12 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
            <a href="/" class="text-gray-400 hover:text-white transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <span class="font-semibold text-sm text-gray-200" id="project-title">Loading...</span>
            <span class="px-2 py-0.5 text-xs bg-blue-900 text-blue-200 rounded-full hidden" id="spa-badge">SPA Mode</span>
        </div>
        <!-- ì¤‘ì•™: Preview/Code í† ê¸€ -->
        <div class="view-toggle flex items-center">
            <button id="view-preview-btn" onclick="setViewMode('preview')" class="active flex items-center gap-1.5">
                <i data-lucide="eye" class="w-3.5 h-3.5"></i> Preview
            </button>
            <button id="view-code-btn" onclick="setViewMode('code')" class="flex items-center gap-1.5 text-gray-400">
                <i data-lucide="code" class="w-3.5 h-3.5"></i> Code
            </button>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- íŒŒì¼ íƒìƒ‰ê¸° í† ê¸€ -->
            <button id="file-explorer-btn" onclick="toggleFileExplorer()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="íŒŒì¼ íƒìƒ‰ê¸°">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
            </button>
            <!-- ìš”ì†Œ ì„ íƒ ëª¨ë“œ -->
            <button id="element-picker-btn" onclick="toggleElementPicker()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="ìš”ì†Œ ì„ íƒ ëª¨ë“œ">
                <i data-lucide="mouse-pointer-click" class="w-4 h-4"></i>
            </button>
            <div class="h-4 w-px bg-gray-600 mx-1"></div>
            <button onclick="reloadFrame()" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="ìƒˆë¡œê³ ì¹¨">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
            <div class="h-4 w-px bg-gray-600 mx-1"></div>
            <button id="device-desktop" onclick="setDevice('desktop')" class="p-2 text-blue-400 bg-gray-700 rounded-lg transition-colors" title="ë°ìŠ¤í¬íƒ‘ ë·°">
                <i data-lucide="monitor" class="w-4 h-4"></i>
            </button>
            <button id="device-mobile" onclick="setDevice('mobile')" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors" title="ëª¨ë°”ì¼ ë·°">
                <i data-lucide="smartphone" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- íŒŒì¼ íƒìƒ‰ê¸° ì‚¬ì´ë“œë°” -->
    <div id="file-explorer" class="fixed left-0 top-12 bottom-0 w-64 bg-gray-800 border-r border-gray-700 z-40 transform -translate-x-full transition-transform duration-300">
        <div class="p-3 border-b border-gray-700 flex items-center justify-between">
            <span class="text-sm font-semibold text-gray-300">íŒŒì¼ íƒìƒ‰ê¸°</span>
            <button onclick="toggleFileExplorer()" class="p-1 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div id="file-list" class="overflow-y-auto p-2" style="height: calc(100% - 50px);"></div>
    </div>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <main class="flex-1 relative bg-gray-900 flex overflow-hidden">
        <!-- Preview íŒ¨ë„ -->
        <div id="preview-panel" class="flex-1 flex justify-center h-full transition-all duration-300">
            <div id="frame-container" class="w-full h-full transition-all duration-300 bg-white shadow-2xl relative">
                <iframe id="site-frame" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
            </div>
        </div>
        
        <!-- Code íŒ¨ë„ -->
        <div id="code-panel" class="hidden flex-1 h-full flex flex-col bg-[#1e1e2e]">
            <!-- íŒŒì¼ íƒ­ ë°” -->
            <div id="code-tabs" class="h-10 bg-gray-800 border-b border-gray-700 flex items-center overflow-x-auto">
                <div id="file-tabs-container" class="flex items-center h-full">
                    <!-- ë™ì ìœ¼ë¡œ íƒ­ ì¶”ê°€ -->
                </div>
            </div>
            
            <!-- ì½”ë“œ ì»¨í…ì¸  ì˜ì—­ -->
            <div class="flex-1 flex overflow-hidden">
                <!-- ë¯¸ë‹ˆ íŒŒì¼ íŠ¸ë¦¬ (ì¢Œì¸¡) -->
                <div id="code-file-tree" class="w-52 bg-gray-900 border-r border-gray-700 overflow-y-auto flex-shrink-0">
                    <div class="p-2 border-b border-gray-700 flex items-center gap-2 text-xs text-gray-400 uppercase font-semibold">
                        <i data-lucide="folder-tree" class="w-3.5 h-3.5"></i> Explorer
                    </div>
                    <div id="code-file-list" class="p-1"></div>
                </div>
                
                <!-- ì½”ë“œ ì—ë””í„° -->
                <div id="code-editor" class="flex-1 overflow-auto code-panel">
                    <div class="p-4 text-gray-500 text-sm flex items-center gap-2">
                        <i data-lucide="file-code" class="w-4 h-4"></i>
                        íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
                    </div>
                </div>
            </div>
            
            <!-- ìƒíƒœ ë°” -->
            <div class="h-6 bg-gray-800 border-t border-gray-700 flex items-center justify-between px-3 text-xs text-gray-500">
                <span id="code-file-path">-</span>
                <span id="code-file-info">-</span>
            </div>
        </div>
    </main>

    <!-- AI ì±„íŒ… íŒ¨ë„ (í”Œë¡œíŒ…) -->
    <div id="ai-panel" class="fixed bottom-6 right-6 w-96 bg-gray-800/95 backdrop-blur-xl border border-gray-600 rounded-2xl shadow-2xl flex flex-col transition-all duration-300 z-50" style="height: 500px;">
        <!-- íŒ¨ë„ í—¤ë” -->
        <div class="h-12 flex items-center justify-between px-4 border-b border-gray-700 cursor-move" id="panel-header">
            <div class="flex items-center gap-2 text-blue-400">
                <i data-lucide="sparkles" class="w-4 h-4"></i>
                <span class="font-semibold text-sm">AI Assistant</span>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="togglePanel()" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded-md transition-colors">
                    <i data-lucide="minus" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- í€µ ì•¡ì…˜ ë°” (í™•ì¥) -->
        <div id="quick-actions" class="px-3 py-2 border-b border-gray-700 space-y-2">
            <!-- ê¸°ë³¸ ì•¡ì…˜ -->
            <div class="flex flex-wrap gap-1.5">
                <button onclick="quickAction('ìƒ‰ìƒ')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-pink-500 to-rose-500 text-white text-xs rounded-md flex items-center gap-1">
                    <i data-lucide="palette" class="w-3 h-3"></i> ìƒ‰ìƒ
                </button>
                <button onclick="quickAction('ì‚­ì œ')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-red-500 to-orange-500 text-white text-xs rounded-md flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> ì‚­ì œ
                </button>
                <button onclick="quickAction('ë²ˆì—­')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-blue-500 to-cyan-500 text-white text-xs rounded-md flex items-center gap-1">
                    <i data-lucide="languages" class="w-3 h-3"></i> ë²ˆì—­
                </button>
                <button onclick="quickAction('ë°˜ì‘í˜•')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-purple-500 to-indigo-500 text-white text-xs rounded-md flex items-center gap-1">
                    <i data-lucide="smartphone" class="w-3 h-3"></i> ë°˜ì‘í˜•
                </button>
            </div>
            <!-- í™•ì¥ ì•¡ì…˜ (í† ê¸€) -->
            <details class="group">
                <summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300 flex items-center gap-1">
                    <i data-lucide="plus-circle" class="w-3 h-3"></i> ë” ë§ì€ ì•¡ì…˜
                </summary>
                <div class="mt-2 flex flex-wrap gap-1.5">
                    <button onclick="quickAction('ë‹¤í¬ëª¨ë“œ')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-gray-600 to-gray-800 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="moon" class="w-3 h-3"></i> ë‹¤í¬ëª¨ë“œ
                    </button>
                    <button onclick="quickAction('í°íŠ¸')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="type" class="w-3 h-3"></i> í°íŠ¸ ë³€ê²½
                    </button>
                    <button onclick="quickAction('ë ˆì´ì•„ì›ƒ')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-teal-500 to-emerald-500 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="layout" class="w-3 h-3"></i> ë ˆì´ì•„ì›ƒ
                    </button>
                    <button onclick="quickAction('ì• ë‹ˆë©”ì´ì…˜')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> ì• ë‹ˆë©”ì´ì…˜
                    </button>
                    <button onclick="quickAction('ì ‘ê·¼ì„±')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-green-500 to-lime-500 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="accessibility" class="w-3 h-3"></i> ì ‘ê·¼ì„±
                    </button>
                    <button onclick="quickAction('SEO')" class="quick-btn px-2.5 py-1 bg-gradient-to-r from-sky-500 to-blue-500 text-white text-xs rounded-md flex items-center gap-1">
                        <i data-lucide="search" class="w-3 h-3"></i> SEO
                    </button>
                </div>
            </details>
        </div>

        <!-- ì„ íƒëœ ìš”ì†Œ í‘œì‹œ -->
        <div id="selected-element-bar" class="hidden px-3 py-2 bg-green-900/50 border-b border-green-700 text-xs">
            <div class="flex items-center justify-between">
                <span class="text-green-300 flex items-center gap-1.5">
                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                    ì„ íƒëœ ìš”ì†Œ: <code id="selected-element-tag" class="bg-green-800 px-1 rounded"></code>
                </span>
                <button onclick="clearSelectedElement()" class="text-green-400 hover:text-white">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            </div>
        </div>

        <!-- ì±„íŒ… ì˜ì—­ -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-900/30">
            <!-- ì›°ì»´ ë©”ì‹œì§€ -->
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg">
                    <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                </div>
                <div class="flex-1">
                    <div class="bg-gray-700/80 p-3 rounded-2xl rounded-tl-none text-sm text-gray-200 leading-relaxed shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br>
                        ğŸ–±ï¸ <b>ìš”ì†Œ ì„ íƒ</b>: ìƒë‹¨ ë²„íŠ¼ í´ë¦­ í›„ í™”ë©´ì—ì„œ ìˆ˜ì •í•  ìš”ì†Œ ì„ íƒ<br>
                        âš¡ <b>í€µ ì•¡ì…˜</b>: ìœ„ ë²„íŠ¼ìœ¼ë¡œ ë¹ ë¥¸ ì‘ì—…<br>
                        ğŸ’¬ <b>ì±„íŒ…</b>: "ë°°ê²½ìƒ‰ì„ íŒŒë€ìƒ‰ìœ¼ë¡œ ë°”ê¿”ì¤˜"
                    </div>
                </div>
            </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="p-3 bg-gray-800 border-t border-gray-700">
            <form id="ai-form" class="relative">
                <input type="text" id="ai-input" 
                       class="w-full bg-gray-900 border border-gray-600 text-white text-sm rounded-xl pl-4 pr-12 py-3 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 placeholder-gray-500 transition-all" 
                       placeholder="AIì—ê²Œ ìˆ˜ì • ìš”ì²­í•˜ê¸°..." autocomplete="off">
                <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-500 transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- ìµœì†Œí™”ëœ ë²„íŠ¼ -->
    <button id="ai-toggle-btn" onclick="togglePanel()" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-blue-600 to-purple-600 rounded-full shadow-lg flex items-center justify-center text-white hover:scale-110 transition-transform z-50 hidden">
        <i data-lucide="sparkles" class="w-7 h-7"></i>
    </button>

    <script>
        lucide.createIcons();
        
        // --- State Management ---
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('projectId');
        const frame = document.getElementById('site-frame');
        const container = document.getElementById('frame-container');
        
        let isPanelOpen = true;
        let isElementPickerActive = false;
        let isFileExplorerOpen = false;
        let selectedElementInfo = null;
        let currentFilePath = 'index.html';
        let lastEditInfo = null; // ì‹¤í–‰ ì·¨ì†Œìš©
        let currentViewMode = 'preview'; // 'preview' or 'code'
        let openFileTabs = []; // ì—´ë¦° íŒŒì¼ íƒ­ ëª©ë¡
        let activeCodeFile = null; // í˜„ì¬ ì½”ë“œ ë·°ì—ì„œ ë³´ê³  ìˆëŠ” íŒŒì¼

        // --- Initialization ---
        if (!projectId) {
            alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤. í”„ë¡œì íŠ¸ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        }

        async function init() {
            try {
                const res = await fetch('/api/projects');
                const projects = await res.json();
                const project = projects.find(p => p.id === projectId);
                
                if (project) {
                    document.getElementById('project-title').textContent = project.domain || projectId;
                    if (project.spaMode) document.getElementById('spa-badge').classList.remove('hidden');
                    
                    const frameSrc = `/projects/${projectId}/index.html?t=${Date.now()}`;
                    frame.src = frameSrc;
                } else {
                    throw new Error('Project not found');
                }
            } catch (e) {
                console.error(e);
                alert('í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        init();

        // --- Preview/Code ë·° ëª¨ë“œ ì „í™˜ ---
        async function setViewMode(mode) {
            currentViewMode = mode;
            const previewBtn = document.getElementById('view-preview-btn');
            const codeBtn = document.getElementById('view-code-btn');
            const previewPanel = document.getElementById('preview-panel');
            const codePanel = document.getElementById('code-panel');
            
            if (mode === 'preview') {
                previewBtn.classList.add('active');
                previewBtn.classList.remove('text-gray-400');
                codeBtn.classList.remove('active');
                codeBtn.classList.add('text-gray-400');
                previewPanel.classList.remove('hidden');
                codePanel.classList.add('hidden');
            } else {
                codeBtn.classList.add('active');
                codeBtn.classList.remove('text-gray-400');
                previewBtn.classList.remove('active');
                previewBtn.classList.add('text-gray-400');
                previewPanel.classList.add('hidden');
                codePanel.classList.remove('hidden');
                
                // ì½”ë“œ ë·° íŒŒì¼ íŠ¸ë¦¬ ë¡œë“œ
                await loadCodeFileTree();
                
                // í˜„ì¬ íŒŒì¼ ë¡œë“œ
                if (!activeCodeFile) {
                    await loadCodeFile(currentFilePath);
                }
            }
        }

        // --- ì½”ë“œ íŒŒì¼ íŠ¸ë¦¬ ë¡œë“œ ---
        async function loadCodeFileTree() {
            const fileList = document.getElementById('code-file-list');
            try {
                const res = await fetch(`/api/files?projectId=${projectId}`);
                const tree = await res.json();
                fileList.innerHTML = renderCodeFileTree(tree, 0);
                lucide.createIcons();
            } catch (e) {
                fileList.innerHTML = '<p class="text-red-400 text-xs p-2">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        function renderCodeFileTree(node, depth) {
            const indent = depth * 12;
            
            if (node.type === 'folder') {
                const children = (node.children || [])
                    .filter(c => /\.(html|css|js|json)$/.test(c.name) || c.type === 'folder')
                    .map(c => renderCodeFileTree(c, depth + 1)).join('');
                if (!children && node.name !== '') return '';
                
                const folderId = `folder-${node.path || 'root'}`.replace(/[\/\\\.]/g, '-');
                return `
                    <div class="folder-group">
                        <div class="file-tree-item flex items-center gap-1 py-1 px-2 cursor-pointer text-gray-400 hover:text-gray-200" 
                             onclick="toggleFolder('${folderId}')" style="padding-left: ${indent + 8}px">
                            <i data-lucide="chevron-right" class="w-3 h-3 folder-toggle" id="toggle-${folderId}"></i>
                            <i data-lucide="folder" class="w-3.5 h-3.5 text-yellow-500"></i>
                            <span class="text-xs truncate">${node.name || 'Project'}</span>
                        </div>
                        <div id="${folderId}" class="folder-children">${children}</div>
                    </div>`;
            } else {
                const ext = node.name.split('.').pop();
                const iconColor = ext === 'css' ? 'text-purple-400' : ext === 'js' ? 'text-yellow-400' : ext === 'html' ? 'text-orange-400' : 'text-blue-400';
                const isActive = node.path === activeCodeFile;
                
                return `
                    <div class="file-tree-item ${isActive ? 'active' : ''} flex items-center gap-1.5 py-1 px-2 cursor-pointer text-gray-400 hover:text-gray-200"
                         onclick="loadCodeFile('${node.path}')" style="padding-left: ${indent + 20}px">
                        <i data-lucide="file-code" class="w-3.5 h-3.5 ${iconColor}"></i>
                        <span class="text-xs truncate">${node.name}</span>
                    </div>`;
            }
        }

        function toggleFolder(folderId) {
            const folder = document.getElementById(folderId);
            const toggle = document.getElementById('toggle-' + folderId);
            if (folder.style.display === 'none') {
                folder.style.display = 'block';
                toggle?.classList.add('open');
            } else {
                folder.style.display = 'none';
                toggle?.classList.remove('open');
            }
        }

        // --- ì½”ë“œ íŒŒì¼ ë¡œë“œ ---
        async function loadCodeFile(filePath) {
            activeCodeFile = filePath;
            
            // íŒŒì¼ íƒ­ ì¶”ê°€
            addFileTab(filePath);
            
            // íŒŒì¼ íŠ¸ë¦¬ í™œì„±í™” ì—…ë°ì´íŠ¸
            document.querySelectorAll('#code-file-list .file-tree-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`#code-file-list .file-tree-item[onclick*="${filePath}"]`)?.classList.add('active');
            
            // íŒŒì¼ ë‚´ìš© ë¡œë“œ
            const editor = document.getElementById('code-editor');
            const pathDisplay = document.getElementById('code-file-path');
            const infoDisplay = document.getElementById('code-file-info');
            
            editor.innerHTML = '<div class="p-4 text-gray-400"><span class="animate-pulse">ë¡œë”© ì¤‘...</span></div>';
            
            try {
                const res = await fetch(`/api/file-content?projectId=${projectId}&filePath=${encodeURIComponent(filePath)}`);
                const data = await res.json();
                
                if (data.success) {
                    const ext = filePath.split('.').pop();
                    const langMap = { 'html': 'markup', 'css': 'css', 'js': 'javascript', 'json': 'javascript' };
                    const lang = langMap[ext] || 'markup';
                    
                    // ì½”ë“œ í•˜ì´ë¼ì´íŒ…
                    const highlighted = Prism.highlight(data.content, Prism.languages[lang], lang);
                    const lines = data.content.split('\n').length;
                    
                    editor.innerHTML = `
                        <pre class="line-numbers" data-start="1"><code class="language-${lang}">${highlighted}</code></pre>
                    `;
                    
                    // Prism ë¼ì¸ ë„˜ë²„ ì¬ì ìš©
                    Prism.highlightAllUnder(editor);
                    
                    // ìƒíƒœë°” ì—…ë°ì´íŠ¸
                    pathDisplay.textContent = filePath;
                    infoDisplay.textContent = `${lines} lines | ${formatFileSize(data.size)} | ${ext.toUpperCase()}`;
                } else {
                    editor.innerHTML = `<div class="p-4 text-red-400">âŒ ${data.error}</div>`;
                }
            } catch (e) {
                editor.innerHTML = `<div class="p-4 text-red-400">âŒ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // --- íŒŒì¼ íƒ­ ê´€ë¦¬ ---
        function addFileTab(filePath) {
            const fileName = filePath.split('/').pop();
            
            // ì´ë¯¸ ì—´ë¦° íƒ­ì¸ì§€ í™•ì¸
            if (openFileTabs.includes(filePath)) {
                // íƒ­ í™œì„±í™”ë§Œ
                updateActiveTab(filePath);
                return;
            }
            
            openFileTabs.push(filePath);
            
            const container = document.getElementById('file-tabs-container');
            const ext = fileName.split('.').pop();
            const iconColor = ext === 'css' ? 'text-purple-400' : ext === 'js' ? 'text-yellow-400' : ext === 'html' ? 'text-orange-400' : 'text-blue-400';
            
            const tab = document.createElement('div');
            tab.className = 'file-tab flex items-center gap-1.5 px-3 h-full cursor-pointer';
            tab.id = `tab-${filePath.replace(/[\/\\\.]/g, '-')}`;
            tab.innerHTML = `
                <i data-lucide="file-code" class="w-3.5 h-3.5 ${iconColor}"></i>
                <span class="text-xs text-gray-300">${fileName}</span>
                <button onclick="event.stopPropagation(); closeFileTab('${filePath}')" class="ml-1 p-0.5 text-gray-500 hover:text-white hover:bg-gray-600 rounded">
                    <i data-lucide="x" class="w-3 h-3"></i>
                </button>
            `;
            tab.onclick = () => loadCodeFile(filePath);
            
            container.appendChild(tab);
            lucide.createIcons();
            
            updateActiveTab(filePath);
        }

        function updateActiveTab(filePath) {
            const tabId = `tab-${filePath.replace(/[\/\\\.]/g, '-')}`;
            document.querySelectorAll('.file-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId)?.classList.add('active');
        }

        function closeFileTab(filePath) {
            const tabId = `tab-${filePath.replace(/[\/\\\.]/g, '-')}`;
            document.getElementById(tabId)?.remove();
            
            openFileTabs = openFileTabs.filter(f => f !== filePath);
            
            // ë‹¤ë¥¸ íƒ­ìœ¼ë¡œ ì „í™˜
            if (openFileTabs.length > 0 && activeCodeFile === filePath) {
                loadCodeFile(openFileTabs[openFileTabs.length - 1]);
            } else if (openFileTabs.length === 0) {
                activeCodeFile = null;
                document.getElementById('code-editor').innerHTML = `
                    <div class="p-4 text-gray-500 text-sm flex items-center gap-2">
                        <i data-lucide="file-code" class="w-4 h-4"></i>
                        íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”
                    </div>`;
                document.getElementById('code-file-path').textContent = '-';
                document.getElementById('code-file-info').textContent = '-';
                lucide.createIcons();
            }
        }

        // --- íŒŒì¼ íƒìƒ‰ê¸° ---
        async function toggleFileExplorer() {
            const explorer = document.getElementById('file-explorer');
            const btn = document.getElementById('file-explorer-btn');
            
            isFileExplorerOpen = !isFileExplorerOpen;
            
            if (isFileExplorerOpen) {
                explorer.classList.remove('-translate-x-full');
                btn.classList.add('text-blue-400', 'bg-gray-700');
                btn.classList.remove('text-gray-400');
                await loadFileList();
            } else {
                explorer.classList.add('-translate-x-full');
                btn.classList.remove('text-blue-400', 'bg-gray-700');
                btn.classList.add('text-gray-400');
            }
        }

        async function loadFileList() {
            const fileList = document.getElementById('file-list');
            try {
                const res = await fetch(`/api/files?projectId=${projectId}`);
                const tree = await res.json();
                fileList.innerHTML = renderFileTree(tree, '');
                lucide.createIcons();
            } catch (e) {
                fileList.innerHTML = '<p class="text-red-400 text-sm">íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        function renderFileTree(node, indent) {
            if (node.type === 'folder') {
                const children = (node.children || [])
                    .filter(c => c.name.endsWith('.html') || c.name.endsWith('.css') || c.type === 'folder')
                    .map(c => renderFileTree(c, indent + '  ')).join('');
                if (!children) return '';
                return `<div class="mb-1">
                    <div class="text-gray-400 text-xs py-1 flex items-center gap-1">
                        <i data-lucide="folder" class="w-3 h-3"></i>${node.name}
                    </div>
                    <div class="ml-3">${children}</div>
                </div>`;
            } else {
                const isHtml = node.name.endsWith('.html');
                const isCss = node.name.endsWith('.css');
                const icon = isCss ? 'file-code' : 'file-text';
                const isActive = node.path === currentFilePath;
                return `<div class="file-item ${isActive ? 'active' : ''} text-xs py-1.5 px-2 rounded cursor-pointer flex items-center gap-2 text-gray-300 hover:text-white" 
                            onclick="selectFile('${node.path}', ${isHtml})">
                    <i data-lucide="${icon}" class="w-3 h-3 ${isCss ? 'text-purple-400' : 'text-blue-400'}"></i>
                    ${node.name}
                </div>`;
            }
        }

        function selectFile(filePath, isHtml) {
            currentFilePath = filePath;
            if (isHtml) {
                frame.src = `/projects/${projectId}/${filePath}?t=${Date.now()}`;
            }
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.file-item')?.classList.add('active');
            addMessage(`ğŸ“ íŒŒì¼ ì„ íƒ: <code>${filePath}</code>`);
        }

        // --- ìš”ì†Œ ì„ íƒ ëª¨ë“œ ---
        function toggleElementPicker() {
            isElementPickerActive = !isElementPickerActive;
            const btn = document.getElementById('element-picker-btn');
            
            if (isElementPickerActive) {
                btn.classList.add('text-green-400', 'bg-green-900');
                btn.classList.remove('text-gray-400');
                addMessage('ğŸ–±ï¸ <b>ìš”ì†Œ ì„ íƒ ëª¨ë“œ í™œì„±í™”</b><br>í™”ë©´ì—ì„œ ìˆ˜ì •í•  ìš”ì†Œë¥¼ í´ë¦­í•˜ì„¸ìš”.');
                setupElementPicker();
            } else {
                btn.classList.remove('text-green-400', 'bg-green-900');
                btn.classList.add('text-gray-400');
                removeElementPicker();
            }
        }

        function setupElementPicker() {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                
                doc.addEventListener('mouseover', handleElementHover);
                doc.addEventListener('mouseout', handleElementOut);
                doc.addEventListener('click', handleElementClick);
            } catch (e) {
                addMessage('âŒ ìš”ì†Œ ì„ íƒ ëª¨ë“œë¥¼ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Cross-origin ì œí•œ)');
                toggleElementPicker();
            }
        }

        function removeElementPicker() {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                doc.removeEventListener('mouseover', handleElementHover);
                doc.removeEventListener('mouseout', handleElementOut);
                doc.removeEventListener('click', handleElementClick);
                doc.querySelectorAll('.element-highlight').forEach(el => el.classList.remove('element-highlight'));
            } catch (e) {}
        }

        function handleElementHover(e) {
            e.target.classList.add('element-highlight');
        }

        function handleElementOut(e) {
            e.target.classList.remove('element-highlight');
        }

        function handleElementClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const el = e.target;
            el.classList.remove('element-highlight');
            el.classList.add('element-selected');
            
            // ìš”ì†Œ ì •ë³´ ì¶”ì¶œ
            const tagName = el.tagName.toLowerCase();
            const classes = el.className.replace('element-selected', '').replace('element-highlight', '').trim();
            const id = el.id;
            const textContent = el.textContent?.substring(0, 50) || '';
            
            // CSS ì„ íƒì ìƒì„±
            let selector = tagName;
            if (id) selector = `#${id}`;
            else if (classes) selector = `${tagName}.${classes.split(' ')[0]}`;
            
            selectedElementInfo = {
                selector,
                tagName,
                outerHTML: el.outerHTML.substring(0, 500),
                text: textContent
            };
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('selected-element-bar').classList.remove('hidden');
            document.getElementById('selected-element-tag').textContent = `<${tagName}>${textContent.substring(0, 20)}...`;
            
            addMessage(`âœ… ìš”ì†Œ ì„ íƒë¨: <code>&lt;${tagName}&gt;</code><br>ì´ì œ ëª…ë ¹ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: "ì´ ìš”ì†Œ ì‚­ì œí•´ì¤˜", "ë°°ê²½ìƒ‰ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ")`);
            
            // ì„ íƒ ëª¨ë“œ ì¢…ë£Œ
            toggleElementPicker();
            
            setTimeout(() => {
                el.classList.remove('element-selected');
            }, 2000);
        }

        function clearSelectedElement() {
            selectedElementInfo = null;
            document.getElementById('selected-element-bar').classList.add('hidden');
        }

        // --- í€µ ì•¡ì…˜ (í™•ì¥) ---
        function quickAction(action) {
            let instruction = '';
            
            switch(action) {
                case 'ìƒ‰ìƒ':
                    const color = prompt('ë³€ê²½í•  ìƒ‰ìƒì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: íŒŒë€ìƒ‰, #3b82f6, blue):', 'íŒŒë€ìƒ‰');
                    if (!color) return;
                    instruction = selectedElementInfo 
                        ? `ì„ íƒëœ ìš”ì†Œ(${selectedElementInfo.selector})ì˜ ë°°ê²½ìƒ‰ì„ ${color}ìœ¼ë¡œ ë³€ê²½í•´ì¤˜`
                        : `í˜ì´ì§€ ì „ì²´ì˜ ì£¼ìš” ìƒ‰ìƒì„ ${color} ê³„ì—´ë¡œ ë³€ê²½í•´ì¤˜`;
                    break;
                case 'ì‚­ì œ':
                    if (!selectedElementInfo) {
                        addMessage('âš ï¸ ë¨¼ì € ì‚­ì œí•  ìš”ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (ìƒë‹¨ì˜ ğŸ–±ï¸ ë²„íŠ¼ í´ë¦­)');
                        return;
                    }
                    instruction = `ì´ ìš”ì†Œë¥¼ ì‚­ì œí•´ì¤˜: ${selectedElementInfo.outerHTML.substring(0, 200)}`;
                    break;
                case 'ë²ˆì—­':
                    instruction = selectedElementInfo 
                        ? `ì„ íƒëœ ìš”ì†Œ(${selectedElementInfo.selector})ì˜ í…ìŠ¤íŠ¸ë¥¼ í•œê¸€ë¡œ ë²ˆì—­í•´ì¤˜`
                        : 'í˜ì´ì§€ì˜ ì˜ì–´ í…ìŠ¤íŠ¸ë¥¼ í•œê¸€ë¡œ ë²ˆì—­í•´ì¤˜';
                    break;
                case 'ë°˜ì‘í˜•':
                    instruction = 'ëª¨ë°”ì¼ì—ì„œ ê¹¨ì§€ëŠ” ìš”ì†Œë“¤ì„ ë°˜ì‘í˜•ìœ¼ë¡œ ìˆ˜ì •í•´ì¤˜. íŠ¹íˆ ê°€ë¡œë¡œ ë„˜ì¹˜ëŠ” ìš”ì†Œë“¤ì„ 100% ë„ˆë¹„ë¡œ ì¡°ì •í•˜ê³ , í°íŠ¸ í¬ê¸°ë¥¼ ì ì ˆíˆ ì¤„ì—¬ì¤˜.';
                    break;
                // ğŸ†• í™•ì¥ ì•¡ì…˜
                case 'ë‹¤í¬ëª¨ë“œ':
                    instruction = 'ì´ í˜ì´ì§€ë¥¼ ë‹¤í¬ëª¨ë“œë¡œ ë³€í™˜í•´ì¤˜. ë°°ê²½ìƒ‰ì„ ì–´ë‘ìš´ ê³„ì—´(#1f2937, #111827)ë¡œ, í…ìŠ¤íŠ¸ëŠ” ë°ì€ ìƒ‰(#f3f4f6, #e5e7eb)ìœ¼ë¡œ ë³€ê²½í•˜ê³ , ë²„íŠ¼ê³¼ ì¹´ë“œë„ ì–´ë‘ìš´ í…Œë§ˆì— ë§ê²Œ ì¡°ì •í•´ì¤˜.';
                    break;
                case 'í°íŠ¸':
                    const font = prompt('ë³€ê²½í•  í°íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:', 'Pretendard, Noto Sans KR');
                    if (!font) return;
                    instruction = selectedElementInfo 
                        ? `ì„ íƒëœ ìš”ì†Œ(${selectedElementInfo.selector})ì˜ í°íŠ¸ë¥¼ ${font}ë¡œ ë³€ê²½í•´ì¤˜`
                        : `í˜ì´ì§€ ì „ì²´ì˜ í°íŠ¸ë¥¼ ${font}ë¡œ ë³€ê²½í•´ì¤˜. @importë‚˜ link íƒœê·¸ë¡œ ì›¹í°íŠ¸ë„ ì¶”ê°€í•´ì¤˜.`;
                    break;
                case 'ë ˆì´ì•„ì›ƒ':
                    const layoutOptions = ['2ì»¬ëŸ¼ â†’ 3ì»¬ëŸ¼', '3ì»¬ëŸ¼ â†’ 2ì»¬ëŸ¼', 'Flexboxë¡œ ë³€ê²½', 'Gridë¡œ ë³€ê²½', 'ì¤‘ì•™ ì •ë ¬'];
                    const layout = prompt(`ë ˆì´ì•„ì›ƒ ë³€ê²½ ì˜µì…˜:\n${layoutOptions.map((o, i) => `${i+1}. ${o}`).join('\n')}\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, '1');
                    if (!layout) return;
                    instruction = selectedElementInfo 
                        ? `ì„ íƒëœ ìš”ì†Œ(${selectedElementInfo.selector})ë¥¼ ${layoutOptions[parseInt(layout)-1] || 'ì¤‘ì•™ ì •ë ¬'}ë¡œ ë³€ê²½í•´ì¤˜`
                        : `ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ì„ ${layoutOptions[parseInt(layout)-1] || 'ì¤‘ì•™ ì •ë ¬'}ë¡œ ë³€ê²½í•´ì¤˜`;
                    break;
                case 'ì• ë‹ˆë©”ì´ì…˜':
                    const animOptions = ['í˜ì´ë“œì¸', 'ìŠ¬ë¼ì´ë“œ', 'í™•ëŒ€/ì¶•ì†Œ', 'í”ë“¤ê¸°', 'í˜¸ë²„ íš¨ê³¼'];
                    const anim = prompt(`ì• ë‹ˆë©”ì´ì…˜ ì˜µì…˜:\n${animOptions.map((o, i) => `${i+1}. ${o}`).join('\n')}\n\në²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`, '1');
                    if (!anim) return;
                    instruction = selectedElementInfo 
                        ? `ì„ íƒëœ ìš”ì†Œ(${selectedElementInfo.selector})ì— ${animOptions[parseInt(anim)-1] || 'í˜ì´ë“œì¸'} ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•´ì¤˜. CSS @keyframesì™€ animation ì†ì„±ì„ ì‚¬ìš©í•´ì¤˜.`
                        : `í˜ì´ì§€ì˜ ì£¼ìš” ìš”ì†Œë“¤ì— ${animOptions[parseInt(anim)-1] || 'í˜ì´ë“œì¸'} ì• ë‹ˆë©”ì´ì…˜ì„ ì¶”ê°€í•´ì¤˜`;
                    break;
                case 'ì ‘ê·¼ì„±':
                    instruction = `ì›¹ ì ‘ê·¼ì„±ì„ ê°œì„ í•´ì¤˜:
1. ëª¨ë“  ì´ë¯¸ì§€ì— ì ì ˆí•œ alt ì†ì„± ì¶”ê°€
2. ë²„íŠ¼ê³¼ ë§í¬ì— aria-label ì¶”ê°€
3. í¼ ìš”ì†Œì— label ì—°ê²°
4. ìƒ‰ìƒ ëŒ€ë¹„ ê°œì„  (ìµœì†Œ 4.5:1)
5. í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ì„ ìœ„í•œ tabindex ì¶”ê°€`;
                    break;
                case 'SEO':
                    instruction = `SEOë¥¼ ê°œì„ í•´ì¤˜:
1. title íƒœê·¸ ìµœì í™” (60ì ì´ë‚´, í‚¤ì›Œë“œ í¬í•¨)
2. meta description ì¶”ê°€/ê°œì„  (160ì ì´ë‚´)
3. Open Graph íƒœê·¸ ì¶”ê°€ (og:title, og:description, og:image)
4. êµ¬ì¡°í™”ëœ ë°ì´í„° (JSON-LD) ì¶”ê°€
5. ì‹œë§¨í‹± íƒœê·¸ ì‚¬ìš© (header, main, footer, article, section)`;
                    break;
            }
            
            if (instruction) {
                document.getElementById('ai-input').value = instruction;
                document.getElementById('ai-form').dispatchEvent(new Event('submit'));
            }
        }

        // --- UI Actions ---
        function reloadFrame() {
            try {
                frame.contentWindow.location.reload();
            } catch(e) {
                frame.src = frame.src;
            }
        }

        function setDevice(type) {
            const desktopBtn = document.getElementById('device-desktop');
            const mobileBtn = document.getElementById('device-mobile');
            
            if (type === 'mobile') {
                container.style.width = '375px';
                container.style.borderRadius = '20px';
                container.style.border = '8px solid #1f2937';
                desktopBtn.classList.replace('text-blue-400', 'text-gray-400');
                desktopBtn.classList.remove('bg-gray-700');
                mobileBtn.classList.replace('text-gray-400', 'text-blue-400');
                mobileBtn.classList.add('bg-gray-700');
            } else {
                container.style.width = '100%';
                container.style.borderRadius = '0';
                container.style.border = 'none';
                mobileBtn.classList.replace('text-blue-400', 'text-gray-400');
                mobileBtn.classList.remove('bg-gray-700');
                desktopBtn.classList.replace('text-gray-400', 'text-blue-400');
                desktopBtn.classList.add('bg-gray-700');
            }
        }

        function togglePanel() {
            const panel = document.getElementById('ai-panel');
            const btn = document.getElementById('ai-toggle-btn');
            
            if (isPanelOpen) {
                panel.classList.add('translate-y-[120%]', 'opacity-0', 'scale-95');
                panel.classList.remove('opacity-100', 'scale-100');
                setTimeout(() => {
                    panel.classList.add('hidden');
                    btn.classList.remove('hidden');
                }, 300);
            } else {
                panel.classList.remove('hidden');
                requestAnimationFrame(() => {
                    panel.classList.remove('translate-y-[120%]', 'opacity-0', 'scale-95');
                    panel.classList.add('opacity-100', 'scale-100');
                });
                btn.classList.add('hidden');
            }
            isPanelOpen = !isPanelOpen;
        }

        // --- ì‹¤í–‰ ì·¨ì†Œ ---
        async function undoLastEdit() {
            if (!lastEditInfo) {
                addMessage('âš ï¸ ë˜ëŒë¦´ ìˆ˜ì • ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const res = await fetch('/api/ai-edit/undo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId,
                        filePath: lastEditInfo.filePath
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    addMessage('â†©ï¸ ì´ì „ ìƒíƒœë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    lastEditInfo = null;
                    reloadFrame();
                } else {
                    addMessage(`âŒ ë³µì› ì‹¤íŒ¨: ${data.error}`);
                }
            } catch (e) {
                addMessage(`âŒ ë³µì› ì˜¤ë¥˜: ${e.message}`);
            }
        }

        // --- AI Logic ---
        const form = document.getElementById('ai-form');
        const input = document.getElementById('ai-input');
        const messages = document.getElementById('chat-messages');

        function addMessage(text, isUser = false, showUndo = false) {
            const div = document.createElement('div');
            div.className = `flex gap-3 msg-anim ${isUser ? 'flex-row-reverse' : ''}`;
            
            const icon = isUser ? 
                `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0"><i data-lucide="user" class="w-4 h-4 text-white"></i></div>` :
                `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0 shadow-lg"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>`;
            
            const bubbleClass = isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-gray-700/80 text-gray-200 rounded-tl-none';
            
            const undoBtn = showUndo ? `<button onclick="undoLastEdit()" class="mt-2 px-3 py-1 bg-yellow-600 hover:bg-yellow-500 text-white text-xs rounded-lg flex items-center gap-1"><i data-lucide="undo-2" class="w-3 h-3"></i> ë˜ëŒë¦¬ê¸°</button>` : '';
            
            div.innerHTML = `
                ${icon}
                <div class="flex-1 flex ${isUser ? 'justify-end' : ''}">
                    <div class="${bubbleClass} p-3 rounded-2xl text-sm leading-relaxed shadow-sm max-w-[90%]">
                        ${text.replace(/\n/g, '<br>')}
                        ${undoBtn}
                    </div>
                </div>
            `;
            
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            lucide.createIcons();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            let text = input.value.trim();
            if (!text) return;

            input.value = '';
            
            // ì„ íƒëœ ìš”ì†Œ ì •ë³´ë¥¼ instructionì— í¬í•¨
            let finalInstruction = text;
            if (selectedElementInfo) {
                finalInstruction = `[ì„ íƒëœ ìš”ì†Œ: ${selectedElementInfo.selector}]\n[ìš”ì†Œ HTML: ${selectedElementInfo.outerHTML}]\n\nì‚¬ìš©ì ìš”ì²­: ${text}`;
            }
            
            addMessage(text, true);
            
            // ë¡œë”© í‘œì‹œ
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'flex gap-3 msg-anim';
            loadingDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>
                <div class="bg-gray-700/80 p-3 rounded-2xl rounded-tl-none text-sm text-gray-400">
                    <span class="animate-pulse">ğŸ”„ AIê°€ ë¶„ì„ ë° ìˆ˜ì • ì¤‘...</span>
                </div>
            `;
            messages.appendChild(loadingDiv);
            messages.scrollTop = messages.scrollHeight;
            lucide.createIcons();

            try {
                // í˜„ì¬ íŒŒì¼ ê²½ë¡œ ê²°ì •
                let targetPath = currentFilePath;
                
                // CSS ê´€ë ¨ ìš”ì²­ì¸ì§€ í™•ì¸
                const isCssRequest = /css|ìŠ¤íƒ€ì¼|ìƒ‰ìƒ|ë°°ê²½|í°íŠ¸|í¬ê¸°|ì—¬ë°±|íŒ¨ë”©|ë§ˆì§„/i.test(text);
                
                // iframeì—ì„œ í˜„ì¬ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                try {
                    const fullUrl = frame.contentWindow.location.href;
                    const urlObj = new URL(fullUrl);
                    const pathParts = urlObj.pathname.split(`/projects/${projectId}/`);
                    if (pathParts.length > 1) {
                        targetPath = decodeURIComponent(pathParts[1]);
                    }
                } catch (e) {}

                const res = await fetch('/api/ai-edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId,
                        filePath: targetPath,
                        instruction: finalInstruction
                    })
                });

                const data = await res.json();
                
                // ë¡œë”© ì œê±°
                document.getElementById(loadingId)?.remove();

                if (data.success) {
                    // ì‹¤í–‰ ì·¨ì†Œ ì •ë³´ ì €ì¥
                    lastEditInfo = {
                        filePath: targetPath,
                        timestamp: Date.now()
                    };
                    
                    // ë³€ê²½ ë‚´ì—­ ë©”ì‹œì§€ ìƒì„±
                    let changeMsg = 'âœ… <b>ìˆ˜ì • ì™„ë£Œ!</b>';
                    if (data.changeInfo) {
                        changeMsg += `<br><span class="text-xs text-gray-400">ğŸ“ ${data.changeInfo.summary} | í¬ê¸°: ${data.changeInfo.sizeDiff} bytes</span>`;
                    }
                    
                    addMessage(changeMsg, false, true); // ì‹¤í–‰ ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
                    
                    // ì„ íƒ ìš”ì†Œ ì´ˆê¸°í™”
                    clearSelectedElement();
                    
                    reloadFrame();
                } else {
                    addMessage(`âŒ ì˜¤ë¥˜ ë°œìƒ: ${data.error}`);
                }
            } catch (err) {
                document.getElementById(loadingId)?.remove();
                addMessage(`âŒ ì„œë²„ í†µì‹  ì˜¤ë¥˜: ${err.message}`);
            }
        });

        // iframe ë¡œë“œ ì™„ë£Œ ì‹œ ìš”ì†Œ ì„ íƒ CSS ì£¼ì…
        frame.addEventListener('load', () => {
            try {
                const doc = frame.contentDocument || frame.contentWindow.document;
                const style = doc.createElement('style');
                style.textContent = `
                    .element-highlight {
                        outline: 3px solid #3b82f6 !important;
                        outline-offset: 2px !important;
                        cursor: crosshair !important;
                    }
                    .element-selected {
                        outline: 3px solid #10b981 !important;
                        outline-offset: 2px !important;
                    }
                `;
                doc.head.appendChild(style);
            } catch (e) {
                console.log('CSS ì£¼ì… ì‹¤íŒ¨ (cross-origin)');
            }
        });
    </script>
</body>
</html>
